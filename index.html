<!DOCTYPE html>
<html>
<head>
    <meta name="generator" content="HTML Tidy for HTML5 for Mac OS X version 5.1.2">
    <meta charset="utf-8">
    <meta name="generator" content="pandoc">
    <meta name="author" content="Charles L. Yost">
    <title>Ansible 300</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
    <link rel="stylesheet" href="reveal.js/css/reveal.css">
    <style type="text/css">
    code{white-space: pre;}
    </style>
    <style type="text/css">
    div.sourceCode { overflow-x: auto; }
    table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
    margin: 0; padding: 0; vertical-align: baseline; border: none; }
    table.sourceCode { width: 100%; line-height: 100%; }
    td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
    td.sourceCode { padding-left: 5px; }
    code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code > span.dt { color: #902000; } /* DataType */
    code > span.dv { color: #40a070; } /* DecVal */
    code > span.bn { color: #40a070; } /* BaseN */
    code > span.fl { color: #40a070; } /* Float */
    code > span.ch { color: #4070a0; } /* Char */
    code > span.st { color: #4070a0; } /* String */
    code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code > span.ot { color: #007020; } /* Other */
    code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code > span.fu { color: #06287e; } /* Function */
    code > span.er { color: #ff0000; font-weight: bold; } /* Error */
    code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    code > span.cn { color: #880000; } /* Constant */
    code > span.sc { color: #4070a0; } /* SpecialChar */
    code > span.vs { color: #4070a0; } /* VerbatimString */
    code > span.ss { color: #bb6688; } /* SpecialString */
    code > span.im { } /* Import */
    code > span.va { color: #19177c; } /* Variable */
    code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code > span.op { color: #666666; } /* Operator */
    code > span.bu { } /* BuiltIn */
    code > span.ex { } /* Extension */
    code > span.pp { color: #bc7a00; } /* Preprocessor */
    code > span.at { color: #7d9029; } /* Attribute */
    code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    </style>
    <link rel="stylesheet" href="reveal.js/css/theme/black.css" id="theme"><!-- Printing and PDF exports -->

    <script>
    var link = document.createElement( 'link' );
    link.rel = 'stylesheet';
    link.type = 'text/css';
    link.href = window.location.search.match( /print-pdf/gi ) ? 'reveal.js/css/print/pdf.css' : 'reveal.js/css/print/paper.css';
    document.getElementsByTagName( 'head' )[0].appendChild( link );
    </script><!--[if lt IE 9]>
  <script src="reveal.js/lib/js/html5shiv.js"></script>
  <![endif]-->
<style>   
.reveal .slides section .fragment.current-visible.current-fragment.collapsable-fragment { display: initial; } 
.reveal .slides section .fragment.current-visible.collapsable-fragment { display: none; } 
h1.subtitle { font-size: 2em; } 
.code { text-align: left; } 
.reveal .small-code { font-size: 30px; } 
.reveal dd > p { margin: 0; } 
figure, img { border:none !important; outline: none !important; } 
</style>  
</head>
<body>
    <div class="reveal">
        <div class="slides">
            <section>
                <h1 class="title">Ansible 300</h1>
                <h1 class="subtitle">Getting in over our heads</h1>
                <h2 class="author">Charles L. Yost</h2>
                <h3 class="date">2015-12</h3>
            </section>
            <section class="slide level1"></section>
            <section id="description" class="slide level1">
                <h1>Description</h1>
                <p>A 45 minute deep dive into Ansible. The inner workings, all the possiblities, and how to really get into some trouble with it. Jam-packed with examples, this talk is intended to be a living cookbook/cheatsheet for when Ansible has you over a barrel, or it's your turn in one.</p>
            </section>
            <section id="speaker-bio" class="slide level1">
                <h1>Speaker Bio</h1>
                <p>Charles Yost is currently a Security Developer at Binary Defense Systems. He has worked in the IT industry for over 10 years in a wide variety of roles including: Printer Technician, VoIP Systems Administrator, .Net Developer, and Web Developer. Throughout life his number one passion has been learning new skills. He can often be found researching a topic, attempting to keep up with the quickly evolving field of technology. Charles enjoys teaching and talking to others about technology. He is a member of NEOISF, and attends as many InfoSec conferences as he can justify with his wife.</p>
            </section>
            <section id="contact" class="slide level1">
                <h1>Contact</h1>
                <p>Twitter: @CHARLESLYOST</p>
                <p>GitHub: Yoshi325</p>
                <p>This Talk:<br>
                <a href="https://github.com/Yoshi325/talks-ansible-3" class="uri">https://github.com/Yoshi325/talks-ansible-3</a></p>
            </section>
            <section id="disclosure" class="slide level1">
                <h1>Disclosure</h1>
                <p>This talk is full of examples. I did not create them. I found them while researching. Proper credit for them can be found at the end in the "Credits" section.</p>
            </section>
            <section id="watch-that-first-step-its-a-doozy" class="slide level1">
                <h1>"Watch that first step, it's a doozy!"</h1>
                <figure>
                    <img src="images/66C538AB-7D9C-4791-99D8-F359978DBABD.jpg" alt="">
                </figure>
            </section>
            <section id="the-ansible-playbook-command" class="slide level1">
                <h1>The ansible-playbook command</h1>
                <p><code>ansible-playbook playbook.yml [OPTIONS]</code></p>
                <aside class="notes">
                    <p>playbook.yml goes right after the command a less often encountered way of handing this in my experiance, you can also put the playbook at the end</p>
                </aside>
            </section>
            <section id="the-tags-option" class="slide level1">
                <h1>The tags option</h1>
                <div class="fragment current-visible collapsable-fragment">
                    For running a specific part or parts of a playbook,<br>
                    rather than the whole thing.
                </div>
                <div class="fragment current-visible collapsable-fragment">
                    <p>Both plays and tasks support the “tags:” attribute.</p>
                </div>
                <div class="fragment current-visible collapsable-fragment">
                    <p><strong>For overriding tag selection: always</strong> <code class="small-code sourceCode">ansible-playbook playbook.yml --tags "always"</code></p>
                </div>
                <div class="fragment current-visible collapsable-fragment">
                    <p><strong>For selecting via meta: ‘tagged’, ‘untagged’ and ‘all’</strong> <code class="small-code sourceCode">ansible-playbook playbook.yml --tags "tagged"</code> <code class="small-code sourceCode">ansible-playbook playbook.yml --tags "untagged"</code> <code class="small-code sourceCode">ansible-playbook playbook.yml --tags "all"</code></p>
                </div>
                <div class="fragment current-visible collapsable-fragment">
                    <p><strong>For including multiple tags:</strong> <code class="small-code sourceCode">ansible-playbook playbook.yml --tags "tag1,tag2"</code></p>
                </div>
                <div class="fragment current-visible collapsable-fragment">
                    <p><strong>For excluding tags:</strong> <code class="small-code sourceCode">ansible-playbook playbook.yml --skip-tags=tag3</code></p>
                </div>
            </section>
            <section id="the-list-options" class="slide level1">
                <h1>The list options</h1>
                <div class="fragment current-visible collapsable-fragment">
                    <p>For listing out parts of the playbook. It is very useful to check your playbook and hosts files before using them.</p>
                </div>
                <div class="fragment current-visible collapsable-fragment">
                    <p><strong>For listing hosts:</strong> <code>ansible-playbook playbook.yml --list-hosts</code></p>
                </div>
                <div class="fragment current-visible collapsable-fragment">
                    <p><strong>For listing all available tags:</strong> <code>ansible-playbook playbook.yml --list-tags</code></p>
                </div>
                <div class="fragment current-visible collapsable-fragment">
                    <p><strong>For listing all tasks that would be executed:</strong> <code>ansible-playbook playbook.yml --list-tasks</code></p>
                </div>
            </section>
            <section id="the-task-options" class="slide level1">
                <h1>The task options</h1>
                <div class="fragment current-visible collapsable-fragment">
                    <p><strong>To start your playbook at a task (by name):</strong> <code class="small-code sourceCode">ansible-playbook playbook.yml --start-at-task="task1"</code></p>
                </div>
                <div class="fragment current-visible collapsable-fragment">
                    <p><strong>To perform a syntax check on your playbook:</strong> <code class="small-code sourceCode">ansible-playbook playbook.yml --syntax-check</code></p>
                </div>
                <div class="fragment current-visible collapsable-fragment">
                    <p><strong>To step though the tasks in your playbook:</strong></p>
                    <p><code>ansible-playbook playbook.yml --step</code></p>
                </div>
                <aside class="notes">
                    <p>step prompts for confirmation before running a task</p>
                </aside>
            </section>
            <section id="the-ansible-command" class="slide level1">
                <h1>The ansible command</h1>
                <pre class="sourceCode"><code>ansible host-pattern   \
--sudo --ask-sudo-pass \
--module-name shell    \
--args="ufw status verbose"</code></pre>
            </section>
            <section id="the-playbook" class="slide level1">
                <h1>The playbook</h1>
                <p><strong>Include tasks from another file</strong></p>
                <div class="fragment current-visible collapsable-fragment">
                    <p><code>- include: tasks/more_tasks.yml</code></p>
                </div>
                <div class="fragment current-visible collapsable-fragment">
                    <p>Be sure to only include a list of tasks.<br>
                    It is not another playbook.<br>
                    But it also requires a document separator <code>---</code>.</p>
                </div>
                <div class="fragment current-visible collapsable-fragment">
                    <p>You can even go so far as to include variables:</p>
                    <p><code class="small-code sourceCode">- include: tasks/more_tasks.yml var1=testing</code></p>
                </div>
            </section>
            <section id="formatting-3-ways" class="slide level1">
                <h1>Formatting 3 Ways</h1>
                <div class="fragment current-visible collapsable-fragment">
                    <pre class="sourceCode"><code>- name: Copy Phergie shell script into place.
  template: src="templates/phergie.sh.j2" dest="/home/{{ phergie_user }}/phergie.sh" owner="{{ phergie_user }}" group="{{ phergie_user }}" mode=0755</code></pre>
                </div>
                <div class="fragment current-visible collapsable-fragment">
                    <pre class="sourceCode"><code>- name: Copy Phergie shell script into place.
  template:
    src: "templates/phergie.sh.j2"
    dest: "/home/{{ phergie_user }}/phergie.sh"
    owner: "{{ phergie_user }}"
    group: "{{ phergie_user }}"
    mode: 0755</code></pre>
                </div>
                <div class="fragment current-visible collapsable-fragment">
                    <pre class="sourceCode"><code>- name: Copy Phergie shell script into place.
  template: &gt;
    src="templates/phergie.sh.j2"
    dest="/home/{{ phergie_user }}/phergie.sh"
    wner="{{ phergie_user }}"
    roup="{{ phergie_user }}"
    mode=0755</code></pre>
                </div>
                <aside class="notes">
                    <p>The last way can actually be used with anything that needs to wrap.</p>
                </aside>
            </section>
            <section class="slide level1">
                <h2 id="recursive-syntax-checking">Recursive Syntax Checking</h2>
                <pre class="sourceCode"><code>find ./playbooks -name '*.yml' -depth 1 \
| xargs -n1                             \
    ansible-playbook                    \
        --syntax-check                  \
        --list-tasks                    \
        -i tests/ansible_hosts</code></pre>
            </section>
            <section id="heavy-shell-action" class="slide level1">
                <h1>Heavy Shell Action</h1>
                <div class="fragment current-visible collapsable-fragment">
                    <pre class="sourceCode"><code>- name: local action math
  local_action: &gt;
    shell {{ IPOctet }}=$(
    echo "{{ ServerIPRange|int }}
    /{{ epcrange|int }}
    +{{ IPOctet|int }}"
    | bc
    )
  with_sequence: start=1 end=4
  register: result
  ignore_errors: yes</code></pre>
                </div>
                <div class="fragment current-visible collapsable-fragment">
                    <p>You can iterate over these results using result.stdout_lines:</p>
                    <pre class="sourceCode"><code>- name: iterate results
  local_action: debug msg={{item}}
  with_items: result.stdout_lines</code></pre>
                </div>
            </section>
            <section class="slide level1">
                <h2 id="lining-them-up">Lining them up,</h2>
                <h2 id="and-knocking-them-down">and knocking them down</h2>
                <pre class="sourceCode"><code>- name: set PHP-FPM parameters
  lineinfile:
    dest: /etc/php-fpm.conf
    regexp: "^{{ item.param }}"
    insertafter: "^;{{ item.param }}"
    line: "{{ item.param }} = {{ item.value }}"
  with_items:
    - { param: 'error_log', value: '/var/log/php-fpm/error.log' }
    - { param: 'log_level', value: 'error' }
    - { param: 'emergency_restart_threshold', value: '10' }</code></pre>
            </section>
            <section id="dynamic-inventory" class="slide level1">
                <h1>Dynamic Inventory</h1>
                <div class="fragment current-visible collapsable-fragment">
                    <p>Dynamic Inventory allows you to pass a script into Ansible's commands, which it uses to obtain a json blob with the inventory.</p>
                </div>
                <div class="fragment current-visible collapsable-fragment">
                    <p>Scripts are provided for:</p>
                    <table style="width:67%;">
                        <colgroup>
                            <col style="width: 33%">
                            <col style="width: 33%">
                        </colgroup>
                        <tbody>
                            <tr class="odd">
                                <td style="text-align: left;">Cobbler BSD Jails Google Compute Engine OpenShift Red Hat's SpaceWalk Zabbix</td>
                                <td style="text-align: left;">Amazon EC2 DigitalOcean Linode OpenStack Nova Vagrant</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="fragment current-visible collapsable-fragment">
                    <p>But you can write one yourself.<br>
                    Say to pull from Active Directory.</p>
                </div>
                <div class="fragment current-visible collapsable-fragment">
                    <p>The output of your script needs to look like this:</p>
                    <div class="sourceCode">
                        <pre class="sourceCode json"><code class="sourceCode json"><span class="fu">{</span>
<span class="dt">"webservers"</span>  <span class="fu">:</span> <span class="ot">[</span> <span class="st">"host2.example.com"</span><span class="ot">,</span> <span class="st">"host3.example.com"</span> <span class="ot">]</span><span class="fu">,</span>
<span class="dt">"databases"</span>   <span class="fu">:</span> <span class="fu">{</span>
    <span class="dt">"hosts"</span>   <span class="fu">:</span> <span class="ot">[</span> <span class="st">"host1.example.com"</span><span class="ot">,</span> <span class="st">"host2.example.com"</span> <span class="ot">]</span><span class="fu">,</span>
     <span class="dt">"vars"</span>   <span class="fu">:</span> <span class="fu">{</span>
        <span class="dt">"a"</span>   <span class="fu">:</span> <span class="kw">true</span>
    <span class="fu">}</span>
<span class="fu">},</span>
<span class="dt">"atlanta"</span>     <span class="fu">:</span> <span class="fu">{</span>
    <span class="dt">"hosts"</span>   <span class="fu">:</span> <span class="ot">[</span> <span class="st">"host1.example.com"</span><span class="ot">,</span> <span class="st">"host4.example.com"</span><span class="ot">]</span><span class="fu">,</span>
    <span class="dt">"vars"</span>    <span class="fu">:</span> <span class="fu">{</span>
        <span class="dt">"b"</span>   <span class="fu">:</span> <span class="kw">false</span>
    <span class="fu">},</span>
    <span class="dt">"children"</span><span class="fu">:</span> <span class="ot">[</span> <span class="st">"marietta"</span><span class="ot">,</span> <span class="st">"5points"</span> <span class="ot">]</span>
<span class="fu">},</span>
<span class="dt">"marietta"</span>    <span class="fu">:</span> <span class="ot">[</span> <span class="st">"host6.example.com"</span> <span class="ot">]</span><span class="fu">,</span>
<span class="dt">"5points"</span>     <span class="fu">:</span> <span class="ot">[</span> <span class="st">"host7.example.com"</span> <span class="ot">]</span>
<span class="fu">}</span></code></pre>
                    </div>
                </div>
            </section>
            <section id="modules" class="slide level1">
                <h1>Modules</h1>
            </section>
            <section class="slide level1">
                <h2 id="core-modules">Core Modules</h2>
                <div class="fragment current-visible collapsable-fragment">
                    <p>The debug module print statements during execution,<br>
                    which can include variables.</p>
                    <p><code>- debug: msg="System {{ inventory_hostname }}</code></p>
                </div>
                <div class="fragment current-visible collapsable-fragment">
                    <p>The accelerate module can increase<br>
                    communication throughput to clients.<br>
                    (Communications are still encrypted.)<br>
                    It is used by adding the following to an ansible play:</p>
                    <p><code>accelrate: true</code></p>
                </div>
                <div class="fragment current-visible collapsable-fragment">
                    <p>The fail module abandons the progress with a custom message.<br>
                    It is most useful when combined with "when"</p>
                    <pre class="sourceCode"><code>- fail: msg="The system may not be provisioned."
  when: cmdb_status != "to-be-staged"</code></pre>
                </div>
                <div class="fragment current-visible collapsable-fragment">
                    <p>The pause module temporarily stops exectuion of a playbook.<br>
                    It can require an amount of time passing, or user input.</p>
                    <pre class="sourceCode"><code># Time Based:
- pause: minutes=5
- pause: seconds=30
# User Input:
- pause: prompt="Check fo org.foo.FooOverload exception"</code></pre>
                </div>
            </section>
            <section id="cowsay-easter-egg" class="slide level1">
                <h1>COWSAY Easter Egg</h1>
                <p>If cowsay is installed, Ansible takes it upon itself to make your day happier when running playbooks. If you decide that you would like to work in a professional cow-free environment, you can either uninstall cowsay, or set an environment variable:</p>
                <p>export ANSIBLE_NOCOWS=1</p>
                <p><a href="https://support.ansible.com/hc/en-us/articles/201957877-How-do-I-disable-cowsay-" class="uri">https://support.ansible.com/hc/en-us/articles/201957877-How-do-I-disable-cowsay-</a></p>
            </section>
            <section id="resources-and-credits" class="slide level1">
                <h1>Resources and Credits</h1>
                <ul>
                    <li>
                        <a href="https://gist.github.com/marktheunissen/2979474" class="uri">https://gist.github.com/marktheunissen/2979474</a>
                    </li>
                    <li>
                        <a href="http://stackoverflow.com/questions/23945201/how-to-run-only-one-task-in-ansible-playbook" class="uri">http://stackoverflow.com/questions/23945201/how-to-run-only-one-task-in-ansible-playbook</a>
                    </li>
                    <li>
                        <a href="http://docs.ansible.com/ansible/playbooks_tags.html" class="uri">http://docs.ansible.com/ansible/playbooks_tags.html</a>
                    </li>
                    <li>
                        <a href="http://stackoverflow.com/a/25452182" class="uri">http://stackoverflow.com/a/25452182</a>
                    </li>
                    <li>
                        <a href="http://sparanoid.com/note/ansible-advanced-lineinfile/" class="uri">http://sparanoid.com/note/ansible-advanced-lineinfile/</a>
                    </li>
                    <li>
                        <a href="https://servercheck.in/blog/yaml-best-practices-ansible-playbooks-tasks" class="uri">https://servercheck.in/blog/yaml-best-practices-ansible-playbooks-tasks</a>
                    </li>
                    <li>
                        <a href="https://raymii.org/s/tutorials/Ansible_-_Playbook_Testing.html" class="uri">https://raymii.org/s/tutorials/Ansible_-_Playbook_Testing.html</a>
                    </li>
                    <li>
                        <a href="http://docs.ansible.com/ansible/intro_dynamic_inventory.html" class="uri">http://docs.ansible.com/ansible/intro_dynamic_inventory.html</a>
                    </li>
                    <li>
                        <a href="http://docs.ansible.com/ansible/developing_inventory.html" class="uri">http://docs.ansible.com/ansible/developing_inventory.html</a>
                    </li>
                    <li>
                        <a href="http://docs.ansible.com/ansible/debug_module.html" class="uri">http://docs.ansible.com/ansible/debug_module.html</a>
                    </li>
                    <li>
                        <a href="http://docs.ansible.com/ansible/accelerate_module.html" class="uri">http://docs.ansible.com/ansible/accelerate_module.html</a>
                    </li>
                    <li>
                        <a href="http://docs.ansible.com/ansible/fail_module.html" class="uri">http://docs.ansible.com/ansible/fail_module.html</a>
                    </li>
                    <li>
                        <a href="http://docs.ansible.com/ansible/pause_module.html" class="uri">http://docs.ansible.com/ansible/pause_module.html</a>
                    </li>
                </ul>
            </section>
        </div>
    </div>
    <script src="reveal.js/lib/js/head.min.js">
    </script> 
    <script src="reveal.js/js/reveal.js">
    </script> 
    <script>

      // Full list of configuration options available at:
      // https://github.com/hakimel/reveal.js#configuration
      Reveal.initialize({
        // Vertical centering of slides
        center: false,
        // Transition style
        transition: 'fade', // none/fade/slide/convex/concave/zoom

        // Optional reveal.js plugins
        dependencies: [
          { src: 'reveal.js/lib/js/classList.js', condition: function() { return !document.body.classList; } },
          { src: 'reveal.js/plugin/zoom-js/zoom.js', async: true },
          { src: 'reveal.js/plugin/notes/notes.js', async: true }
        ]
      });
    </script>
</body>
</html>
